<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d1117">
<title>ERB System â€” GestiÃ³n Documental</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root {
  --accent: #4d9fff; --accent-hover: #6cb3ff; --accent-dark: #2d7ad6;
  --bg-deep: #0d1117; --bg-primary: #161b22; --bg-card: #1c2129;
  --bg-input: #21262d; --bg-elevated: #282e38;
  --border: #30363d; --border-focus: #4d9fff;
  --text-primary: #f0f6fc; --text-secondary: #8b949e; --text-muted: #484f58;
  --green: #2ea043; --green-hover: #3fb950;
  --red: #da3633; --red-hover: #f85149;
  --orange: #d29922; --whatsapp: #25D366;
  --radius: 12px; --radius-sm: 8px;
  --shadow-card: 0 6px 20px rgba(0,0,0,0.3);
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; }
body {
  font-family: var(--font); background: var(--bg-deep); color: var(--text-primary);
  min-height: 100vh; min-height: 100dvh; overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
::selection { background: var(--accent-dark); color: white; }

/* â•â•â• ANIMATIONS â•â•â• */
@keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(77,159,255,0.4); } 50% { box-shadow: 0 0 0 8px rgba(77,159,255,0); } }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
@keyframes spin { to { transform: rotate(360deg); } }

.fade-in { animation: fadeIn 0.4s ease-out both; }
.slide-up { animation: slideUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) both; }

/* â•â•â• HEADER â•â•â• */
.app-header {
  background: linear-gradient(135deg, var(--bg-primary), var(--bg-deep));
  border-bottom: 1px solid var(--border); padding: 0 20px; height: 56px;
  display: flex; align-items: center; gap: 12px;
  position: sticky; top: 0; z-index: 100; backdrop-filter: blur(12px);
}
.app-header .logo-dot {
  width: 10px; height: 10px; border-radius: 50%; background: var(--accent);
  animation: pulse 2s ease-in-out infinite; flex-shrink: 0;
}
.app-header h1 {
  font-size: 1.1rem; font-weight: 800; letter-spacing: 2px; color: var(--text-primary);
}
.app-header .subtitle {
  font-size: 0.75rem; color: var(--text-muted); font-weight: 400;
  display: none;
}
@media (min-width: 640px) { .app-header .subtitle { display: inline; } }
.header-actions { margin-left: auto; display: flex; gap: 8px; }

/* â•â•â• NAV TABS â•â•â• */
.nav-bar {
  background: var(--bg-primary); border-bottom: 1px solid var(--border);
  padding: 0 16px; display: flex; align-items: stretch; gap: 4px;
  overflow-x: auto; -webkit-overflow-scrolling: touch;
}
.nav-bar::-webkit-scrollbar { height: 0; }
.tab-btn {
  padding: 12px 20px; background: transparent; border: none; color: var(--text-muted);
  font: 500 0.85rem var(--font); cursor: pointer; white-space: nowrap;
  border-top: 3px solid transparent; transition: all 0.2s;
  position: relative;
}
.tab-btn:hover { color: var(--text-secondary); background: var(--bg-card); }
.tab-btn.active { color: var(--text-primary); border-top-color: var(--accent); font-weight: 700; }
.tab-btn .dirty-dot {
  display: none; width: 6px; height: 6px; border-radius: 50%;
  background: var(--orange); position: absolute; top: 8px; right: 8px;
}
.tab-btn.dirty .dirty-dot { display: block; }
.tab-btn .close-tab {
  margin-left: 8px; opacity: 0.4; font-size: 0.8rem; transition: opacity 0.2s;
}
.tab-btn .close-tab:hover { opacity: 1; color: var(--red); }

/* â•â•â• BUTTONS â•â•â• */
.btn {
  display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px;
  border: none; border-radius: var(--radius-sm); font: 600 0.85rem var(--font);
  cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
  text-decoration: none; white-space: nowrap;
}
.btn::after {
  content: ''; position: absolute; inset: 0; opacity: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: opacity 0.3s;
}
.btn:hover::after { opacity: 1; animation: shimmer 0.8s; }
.btn-primary { background: var(--accent); color: white; box-shadow: 0 2px 12px rgba(77,159,255,0.3); }
.btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(77,159,255,0.4); }
.btn-green { background: var(--green); color: white; }
.btn-green:hover { background: var(--green-hover); }
.btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
.btn-ghost:hover { border-color: var(--text-muted); color: var(--text-primary); background: var(--bg-elevated); }
.btn-danger { background: transparent; color: var(--red); border: 1px solid var(--border); }
.btn-danger:hover { border-color: var(--red); background: rgba(218,54,51,0.1); }
.btn-orange { background: transparent; color: var(--orange); border: 1px solid var(--orange); }
.btn-orange:hover { background: rgba(210,153,34,0.12); }
.btn-wa { background: var(--whatsapp); color: white; font-weight: 700; }
.btn-wa:hover { background: #1ebe5d; }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; }
.btn-icon {
  width: 36px; height: 36px; padding: 0; display: flex; align-items: center;
  justify-content: center; border-radius: 50%; font-size: 1rem;
}
.btn:disabled { opacity: 0.4; pointer-events: none; }

/* â•â•â• FORMS â•â•â• */
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 0.78rem; color: var(--text-secondary); font-weight: 500; }
.form-input, .form-select, .form-textarea {
  background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 10px 14px; color: var(--text-primary); font: 400 0.9rem var(--font);
  transition: border-color 0.2s, background 0.2s; width: 100%;
}
.form-input:hover, .form-select:hover, .form-textarea:hover { border-color: var(--text-muted); background: var(--bg-elevated); }
.form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); background: var(--bg-elevated); box-shadow: 0 0 0 3px rgba(77,159,255,0.1); }
.form-input::placeholder { color: var(--text-muted); }
.form-textarea { resize: vertical; min-height: 70px; font-family: var(--font); }
.form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
input[type="date"] { color-scheme: dark; }
.form-check { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.form-check input[type="checkbox"] {
  width: 20px; height: 20px; border-radius: 6px; border: 2px solid var(--border);
  background: var(--bg-input); appearance: none; cursor: pointer; transition: all 0.2s;
  display: grid; place-content: center;
}
.form-check input:checked { background: var(--accent); border-color: var(--accent); }
.form-check input:checked::before { content: 'âœ“'; color: white; font-size: 0.7rem; font-weight: 700; }
.form-check label { font-size: 0.85rem; color: var(--text-secondary); cursor: pointer; }

/* â•â•â• CARDS â•â•â• */
.card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 20px; box-shadow: var(--shadow-card);
}
.card-title {
  font-size: 0.85rem; font-weight: 600; color: var(--accent); margin-bottom: 16px;
  display: flex; align-items: center; gap: 8px;
}
.card-title::before {
  content: ''; width: 3px; height: 16px; background: var(--accent); border-radius: 2px;
}

/* â•â•â• LAYOUT â•â•â• */
.main-content { padding: 20px; max-width: 1400px; margin: 0 auto; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
.flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.gap-sm { gap: 8px; }
.gap-md { gap: 16px; }
.mt-md { margin-top: 16px; }
.mb-md { margin-bottom: 16px; }

/* â•â•â• SEPARATOR â•â•â• */
.separator {
  height: 2px; border: none; margin: 8px 0;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0.5;
}

/* â•â•â• TOOLBAR â•â•â• */
.toolbar {
  background: var(--bg-primary); border-bottom: 1px solid var(--border);
  padding: 10px 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
}

/* â•â•â• CONCEPTOS TABLE â•â•â• */
.conceptos-header {
  display: grid; grid-template-columns: 40px 1fr 70px 100px 36px; gap: 8px;
  padding: 8px 0; border-bottom: 1px solid var(--border);
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
}
.concepto-row {
  display: grid; grid-template-columns: 40px 1fr 70px 100px 36px; gap: 8px;
  padding: 6px 0; align-items: center;
  animation: fadeIn 0.3s ease-out;
}
.concepto-row .move-btns { display: flex; flex-direction: column; gap: 2px; }
.concepto-row .move-btns button {
  width: 26px; height: 18px; border: 1px solid var(--border); background: transparent;
  color: var(--text-muted); border-radius: 4px; cursor: pointer; font-size: 0.6rem;
  display: flex; align-items: center; justify-content: center; transition: all 0.15s;
}
.concepto-row .move-btns button:hover { color: var(--accent); border-color: var(--accent); background: rgba(77,159,255,0.08); }
.delete-row-btn {
  width: 32px; height: 32px; border: none; background: transparent; color: var(--red);
  border-radius: 50%; cursor: pointer; font-size: 1.1rem; transition: all 0.15s;
  display: flex; align-items: center; justify-content: center;
}
.delete-row-btn:hover { background: rgba(218,54,51,0.15); color: var(--red-hover); }

@media (max-width: 600px) {
  .conceptos-header { grid-template-columns: 1fr 60px 80px 30px; }
  .concepto-row { grid-template-columns: 1fr 60px 80px 30px; }
  .concepto-row .move-btns { display: none; }
  .conceptos-header span:first-child { display: none; }
}

/* â•â•â• TOTALS PANEL â•â•â• */
.totals-panel {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
  padding: 20px; box-shadow: var(--shadow-card);
  display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;
}
.totals-options { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
.totals-display { display: flex; gap: 24px; flex-wrap: wrap; align-items: flex-end; }
.total-item { text-align: right; }
.total-item .label { font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.total-item .value { font-size: 1.4rem; font-weight: 700; color: var(--accent); font-family: var(--mono); }
.total-item .value.grand { font-size: 1.8rem; }

/* â•â•â• MODAL â•â•â• */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
  display: flex; align-items: center; justify-content: center; padding: 20px;
  backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
.modal-overlay.active { opacity: 1; pointer-events: auto; }
.modal {
  background: var(--bg-primary); border: 1px solid var(--border); border-radius: 16px;
  width: 100%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.3s;
}
.modal-overlay.active .modal { transform: scale(1); }
.modal-header {
  padding: 20px 24px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.modal-header h2 { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
.modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }

/* â•â•â• HISTORY LIST â•â•â• */
.history-item {
  padding: 14px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
  margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
  display: flex; justify-content: space-between; align-items: center; gap: 12px;
}
.history-item:hover { background: var(--bg-elevated); border-color: var(--text-muted); }
.history-item.selected { background: var(--accent-dark); border-color: var(--accent); }
.history-item .info { flex: 1; min-width: 0; }
.history-item .info .title { font-weight: 600; font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.history-item .info .meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 3px; }
.history-item .actions { display: flex; gap: 6px; flex-shrink: 0; }

/* â•â•â• AUTOCOMPLETE â•â•â• */
.autocomplete-wrap { position: relative; }
.autocomplete-list {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
  max-height: 180px; overflow-y: auto; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}
.autocomplete-list.show { display: block; }
.autocomplete-item {
  padding: 10px 14px; cursor: pointer; font-size: 0.85rem; color: var(--text-secondary);
  border-bottom: 1px solid rgba(48,54,61,0.5); transition: background 0.15s;
}
.autocomplete-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
.autocomplete-item:last-child { border-bottom: none; }
.autocomplete-item .sub { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }

/* â•â•â• FOOTER STATUS â•â•â• */
.app-footer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg-primary); border-top: 1px solid var(--border);
  padding: 6px 20px; display: flex; justify-content: space-between;
  font-size: 0.72rem; color: var(--text-muted); z-index: 100;
}
.app-footer .status-msg { color: var(--accent); font-weight: 600; transition: opacity 0.3s; }
.app-footer .status-msg.idle { color: var(--text-muted); font-weight: 400; }
body { padding-bottom: 32px; }

/* â•â•â• LOADING â•â•â• */
.loading-spinner {
  width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block;
}

/* â•â•â• TOAST â•â•â• */
.toast-container { position: fixed; top: 70px; right: 20px; z-index: 300; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 12px 18px; font-size: 0.85rem; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  animation: slideUp 0.3s ease-out; display: flex; align-items: center; gap: 8px;
  max-width: 360px;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error { border-left: 3px solid var(--red); }
.toast.info { border-left: 3px solid var(--accent); }

/* â•â•â• SECTION HIDDEN â•â•â• */
.section-hidden { display: none !important; }

/* â•â•â• PDF via iframe â€” no render area needed â•â•â• */

/* â•â•â• RESPONSIVE TWEAKS â•â•â• */
@media (max-width: 600px) {
  .main-content { padding: 12px; }
  .card { padding: 14px; }
  .btn { padding: 8px 14px; font-size: 0.8rem; }
  .app-header { padding: 0 12px; }
  .toolbar { padding: 8px 12px; }
  .totals-display { gap: 14px; }
  .total-item .value { font-size: 1.1rem; }
  .total-item .value.grand { font-size: 1.4rem; }
}
</style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<header class="app-header">
  <div class="logo-dot"></div>
  <h1>ERB SYSTEM</h1>
  <span class="subtitle">GestiÃ³n Documental</span>
  <div class="header-actions">
    <button class="btn btn-ghost btn-sm" onclick="showHistory()" title="Historial">ğŸ“‚ Historial</button>
    <button class="btn btn-ghost btn-sm" onclick="showSettings()" title="Ajustes">âš™ï¸</button>
  </div>
</header>

<!-- â•â•â• TOOLBAR â•â•â• -->
<div class="toolbar">
  <button class="btn btn-green btn-sm" onclick="newTab()">+ Nuevo</button>
  <button class="btn btn-ghost btn-sm" onclick="generateCombinedPDF()">ğŸ“‘ PDF Combinado</button>
  <div style="flex:1"></div>
  <div id="tab-nav" class="nav-bar" style="background:transparent; border:none; padding:0;"></div>
</div>

<!-- â•â•â• MAIN CONTENT â•â•â• -->
<div class="main-content" id="app-content"></div>

<!-- â•â•â• MODAL â•â•â• -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-title">Modal</h2>
      <button class="btn btn-icon btn-ghost" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<!-- â•â•â• TOAST â•â•â• -->
<div class="toast-container" id="toasts"></div>

<!-- â•â•â• FOOTER â•â•â• -->
<footer class="app-footer">
  <span id="status-text" class="status-msg idle">Listo</span>
  <span id="clock"></span>
</footer>

<!-- PDF se genera via iframe temporal -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_KEY = 'erb_system';
let state = {
  tabs: [],          // [{id, data, dirty}]
  activeTab: null,
  perfiles: {},
  clientes: {},      // {nombre: {dni, direccion, telefono}}
  historial: [],     // [{id, tipo, numero, fecha, cliente, total, data, creado}]
  config: { perfil_default: 'SERVICIOS_TECNICOS_ERB' }
};

function loadState() {
  try {
    const saved = localStorage.getItem(DB_KEY);
    if (saved) {
      const s = JSON.parse(saved);
      state.perfiles = s.perfiles || {};
      state.clientes = s.clientes || {};
      state.historial = s.historial || [];
      state.config = s.config || state.config;
    }
  } catch(e) { console.warn('Error loading state:', e); }
  // Default profile
  if (!state.perfiles['SERVICIOS_TECNICOS_ERB']) {
    state.perfiles['SERVICIOS_TECNICOS_ERB'] = {
      nombre: 'SERVICIOS TECNICOS ERB S.L', nif: 'B25946310',
      direccion: 'CL CARRETERA DE MORVEDRE 8 2 5\n46529 CANET D\'EN BERENGUER\nVALENCIA',
      telefono: '', email: '', iban: 'ES21 0000 0000 0000 0000 0000',
      logo: '', color_tema: '#1a4f8b'
    };
  }
}

function saveState() {
  try {
    localStorage.setItem(DB_KEY, JSON.stringify({
      perfiles: state.perfiles, clientes: state.clientes,
      historial: state.historial, config: state.config
    }));
  } catch(e) { console.warn('Error saving state:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _tabIdCounter = 0;
function genId() { return 'tab_' + (++_tabIdCounter) + '_' + Date.now(); }
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function today() { return new Date().toISOString().slice(0, 10); }
function todayDMY() { const d = new Date(); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
function formatMoney(n) { return (n || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' â‚¬'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST & STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type = 'info') {
  const c = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
}

function setStatus(msg, duration = 3000) {
  const el = document.getElementById('status-text');
  el.textContent = msg; el.classList.remove('idle');
  if (duration > 0) setTimeout(() => { el.textContent = 'Listo'; el.classList.add('idle'); }, duration);
}

function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleString('es-ES', {
    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
}
setInterval(updateClock, 1000); updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newTab(data = null) {
  const id = genId();
  const perfil = state.perfiles[state.config.perfil_default] || Object.values(state.perfiles)[0] || {};
  const tabData = data || {
    tipo_documento: 'PRESUPUESTO', perfil_key: state.config.perfil_default,
    empresa: { ...perfil }, cliente: { nombre: '', dni: '', direccion: '', telefono: '' },
    detalles: { numero: '', fecha: today() },
    tecnico: { equipo: '', marca: '', averia: '', diagnostico: '' },
    conceptos: [{ descripcion: '', cantidad: 1, precio_base: 0 }],
    notas: '', aplicar_iva: true, iva_porcentaje: 21, descuento_pct: 0,
    mostrar_cantidad: false, mostrar_notas: true, mostrar_totales: true
  };
  state.tabs.push({ id, data: tabData, dirty: false, undoStack: [] });
  state.activeTab = id;
  renderTabs(); renderActiveTab();
  toast('âœ“ Nueva pestaÃ±a creada', 'success');
}

function switchTab(id) {
  saveCurrentTabData();
  state.activeTab = id;
  renderTabs(); renderActiveTab();
}

function closeTab(id) {
  const tab = state.tabs.find(t => t.id === id);
  if (state.tabs.length <= 1) return;
  if (tab && tab.dirty) {
    if (!confirm('Esta pestaÃ±a tiene cambios sin guardar â—\nÂ¿Cerrar de todos modos?')) return;
  }
  state.tabs = state.tabs.filter(t => t.id !== id);
  if (state.activeTab === id) state.activeTab = state.tabs[state.tabs.length - 1]?.id;
  renderTabs(); renderActiveTab();
}

function renderTabs() {
  const nav = document.getElementById('tab-nav');
  nav.innerHTML = state.tabs.map(t => {
    const d = t.data;
    const tipo = d.tipo_documento === 'PRESUPUESTO' ? 'Presup' : (d.tipo_documento === 'FACTURA' ? 'Fact' : 'Inf');
    const cli = d.cliente?.nombre || 'Nuevo';
    const active = t.id === state.activeTab ? 'active' : '';
    const dirty = t.dirty ? 'dirty' : '';
    return `<button class="tab-btn ${active} ${dirty}" onclick="switchTab('${t.id}')">
      ${esc(tipo)} â€” ${esc(cli.substring(0,15))}
      <span class="dirty-dot"></span>
      ${state.tabs.length > 1 ? `<span class="close-tab" onclick="event.stopPropagation();closeTab('${t.id}')">âœ•</span>` : ''}
    </button>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ACTIVE TAB (THE BIG ONE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderActiveTab() {
  const tab = state.tabs.find(t => t.id === state.activeTab);
  if (!tab) { document.getElementById('app-content').innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:60px;">Sin pestaÃ±as abiertas</p>'; return; }
  const d = tab.data;
  const perfilOptions = Object.keys(state.perfiles).map(k =>
    `<option value="${esc(k)}" ${k === d.perfil_key ? 'selected' : ''}>${esc(k)}</option>`).join('');

  const conceptosRows = (d.conceptos || []).map((c, i) => `
    <div class="concepto-row" data-idx="${i}">
      <div class="move-btns">
        <button onclick="moveRow(${i},-1)" title="Subir">â–²</button>
        <button onclick="moveRow(${i},1)" title="Bajar">â–¼</button>
      </div>
      <input class="form-input" value="${esc(c.descripcion)}" placeholder="DescripciÃ³n..." onchange="updateConcepto(${i},'descripcion',this.value)">
      <input class="form-input" type="number" min="0" step="0.01" value="${c.cantidad}" style="text-align:center" onchange="updateConcepto(${i},'cantidad',this.value)">
      <input class="form-input" type="number" min="0" step="0.01" value="${c.precio_base}" style="text-align:right" onchange="updateConcepto(${i},'precio_base',this.value)">
      <button class="delete-row-btn" onclick="deleteRow(${i})" title="Eliminar">âœ•</button>
    </div>`).join('');

  const totals = calcTotals(d);
  const isTecnico = d.tipo_documento === 'INFORME TÃ‰CNICO';

  document.getElementById('app-content').innerHTML = `
    <div class="fade-in">
      <!-- Logo preview -->
      ${d.empresa.logo ? `<div style="text-align:center;margin-bottom:16px;"><img src="${d.empresa.logo}" style="max-height:80px;border-radius:8px;opacity:0.8" onerror="this.style.display='none'"></div>` : ''}

      <!-- Top controls -->
      <div class="flex-row mb-md" style="flex-wrap:wrap;gap:10px;">
        <div class="form-group" style="min-width:180px">
          <label class="form-label">Perfil Empresa</label>
          <select class="form-select" onchange="changePerfil(this.value)">${perfilOptions}</select>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="savePerfilFromTab()">ğŸ’¾ Guardar Perfil</button>
        <div style="flex:1"></div>
        <div class="form-group" style="min-width:160px">
          <label class="form-label">Tipo Documento</label>
          <select class="form-select" onchange="updateField('tipo_documento',this.value);renderActiveTab()">
            <option ${d.tipo_documento==='PRESUPUESTO'?'selected':''}>PRESUPUESTO</option>
            <option ${d.tipo_documento==='FACTURA'?'selected':''}>FACTURA</option>
            <option ${d.tipo_documento==='INFORME TÃ‰CNICO'?'selected':''}>INFORME TÃ‰CNICO</option>
          </select>
        </div>
        <button class="btn btn-danger btn-sm" onclick="clearTab()">ğŸ—‘ Limpiar</button>
      </div>

      <hr class="separator">

      <!-- Emisor / Receptor -->
      <div class="grid-2 mb-md">
        <div class="card slide-up" style="animation-delay:0.05s">
          <div class="card-title">Tus Datos (Emisor)</div>
          <div class="form-group mb-md"><label class="form-label">RazÃ³n Social</label><input class="form-input" value="${esc(d.empresa.nombre)}" onchange="updateField('empresa.nombre',this.value)"></div>
          <div class="flex-row gap-sm mb-md">
            <div class="form-group" style="flex:1"><label class="form-label">NIF</label><input class="form-input" value="${esc(d.empresa.nif)}" onchange="updateField('empresa.nif',this.value)"></div>
            <div class="form-group" style="flex:1"><label class="form-label">TelÃ©fono</label><input class="form-input" value="${esc(d.empresa.telefono)}" onchange="updateField('empresa.telefono',this.value)"></div>
          </div>
          <div class="form-group mb-md"><label class="form-label">DirecciÃ³n</label><textarea class="form-textarea" rows="2" onchange="updateField('empresa.direccion',this.value)">${esc(d.empresa.direccion)}</textarea></div>
          <div class="flex-row gap-sm mb-md">
            <div class="form-group" style="flex:1"><label class="form-label">Email</label><input class="form-input" type="email" value="${esc(d.empresa.email)}" onchange="updateField('empresa.email',this.value)"></div>
            <div class="form-group" style="flex:1"><label class="form-label">IBAN</label><input class="form-input" value="${esc(d.empresa.iban)}" onchange="updateField('empresa.iban',this.value)"></div>
          </div>
          <div class="flex-row gap-sm">
            <div class="form-group" style="flex:1"><label class="form-label">Logo (URL o Base64)</label><input class="form-input" value="${esc(d.empresa.logo)}" placeholder="https://... o pega base64" onchange="updateField('empresa.logo',this.value)"></div>
            <button class="btn btn-ghost btn-sm" onclick="pickLogoFile()" title="Subir imagen">ğŸ“‚</button>
            <input type="file" id="logo-file-input" accept="image/*" style="display:none" onchange="handleLogoFile(this)">
            <div class="form-group" style="width:70px"><label class="form-label">Color</label><input type="color" value="${d.empresa.color_tema||'#1a4f8b'}" onchange="updateField('empresa.color_tema',this.value)" style="width:100%;height:36px;border:none;cursor:pointer;border-radius:6px;"></div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:16px;">
          <div class="card slide-up" style="animation-delay:0.1s">
            <div class="card-title">Cliente (Receptor)</div>
            <div class="form-group mb-md autocomplete-wrap">
              <label class="form-label">Nombre Cliente</label>
              <input class="form-input" id="client-name-input" value="${esc(d.cliente.nombre)}" placeholder="Escribe para buscar..." oninput="onClientInput(this)" onchange="updateField('cliente.nombre',this.value)">
              <div class="autocomplete-list" id="client-autocomplete"></div>
            </div>
            <div class="flex-row gap-sm mb-md">
              <div class="form-group" style="flex:1"><label class="form-label">DNI/NIF</label><input class="form-input" id="client-dni" value="${esc(d.cliente.dni)}" onchange="updateField('cliente.dni',this.value)"></div>
              <div class="form-group" style="flex:1"><label class="form-label">TelÃ©fono</label><input class="form-input" id="client-tel" value="${esc(d.cliente.telefono)}" placeholder="34600123456" onchange="updateField('cliente.telefono',this.value)"></div>
            </div>
            <div class="form-group"><label class="form-label">DirecciÃ³n</label><textarea class="form-textarea" id="client-dir" rows="2" onchange="updateField('cliente.direccion',this.value)">${esc(d.cliente.direccion)}</textarea></div>
          </div>
          <div class="card slide-up" style="animation-delay:0.15s">
            <div class="card-title">Metadatos</div>
            <div class="flex-row gap-sm">
              <div class="form-group" style="flex:1"><label class="form-label">NÂº Documento</label><input class="form-input" value="${esc(d.detalles.numero)}" onchange="updateField('detalles.numero',this.value)"></div>
              <div class="form-group" style="flex:1"><label class="form-label">Fecha</label><input class="form-input" type="date" value="${d.detalles.fecha||today()}" onchange="updateField('detalles.fecha',this.value)"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TÃ©cnico (conditional) -->
      <div class="card mb-md slide-up ${isTecnico ? '' : 'section-hidden'}" style="animation-delay:0.18s" id="seccion-tecnico">
        <div class="card-title">Datos TÃ©cnicos</div>
        <div class="flex-row gap-sm mb-md">
          <div class="form-group" style="flex:1"><label class="form-label">Equipo</label><input class="form-input" value="${esc(d.tecnico.equipo)}" onchange="updateField('tecnico.equipo',this.value)"></div>
          <div class="form-group" style="flex:1"><label class="form-label">Marca</label><input class="form-input" value="${esc(d.tecnico.marca)}" onchange="updateField('tecnico.marca',this.value)"></div>
        </div>
        <div class="form-group mb-md"><label class="form-label">AverÃ­a</label><textarea class="form-textarea" rows="2" onchange="updateField('tecnico.averia',this.value)">${esc(d.tecnico.averia)}</textarea></div>
        <div class="form-group"><label class="form-label">DiagnÃ³stico</label><textarea class="form-textarea" rows="2" onchange="updateField('tecnico.diagnostico',this.value)">${esc(d.tecnico.diagnostico)}</textarea></div>
      </div>

      <!-- Conceptos -->
      <div class="card mb-md slide-up" style="animation-delay:0.2s">
        <div class="card-title">Conceptos</div>
        <div class="conceptos-header">
          <span></span><span>DescripciÃ³n</span><span style="text-align:center">Cant.</span><span style="text-align:right">Precio â‚¬</span><span></span>
        </div>
        <div id="conceptos-list">${conceptosRows}</div>
        <div class="flex-row mt-md" style="gap:8px">
          <button class="btn btn-green btn-sm" onclick="addRow()">+ AÃ±adir Concepto</button>
          <button class="btn btn-orange btn-sm ${tab.undoStack.length?'':'section-hidden'}" id="undo-btn" onclick="undoDelete()">â†© Deshacer (${tab.undoStack.length})</button>
        </div>
      </div>

      <!-- Totals -->
      <div class="totals-panel mb-md slide-up" style="animation-delay:0.25s">
        <div class="totals-options">
          <div class="flex-row gap-sm">
            <label class="form-check"><input type="checkbox" ${d.aplicar_iva?'checked':''} onchange="updateField('aplicar_iva',this.checked);renderActiveTab()"><label>Aplicar IVA</label></label>
            <select class="form-select" style="width:80px" onchange="updateField('iva_porcentaje',parseInt(this.value));recalcTotals()">
              <option value="21" ${d.iva_porcentaje==21?'selected':''}>21%</option>
              <option value="10" ${d.iva_porcentaje==10?'selected':''}>10%</option>
              <option value="4" ${d.iva_porcentaje==4?'selected':''}>4%</option>
            </select>
          </div>
          <div class="flex-row gap-sm">
            <label class="form-label" style="margin:0;line-height:36px">Descuento:</label>
            <input class="form-input" type="number" min="0" max="100" value="${d.descuento_pct||0}" style="width:70px;text-align:center" onchange="updateField('descuento_pct',parseInt(this.value)||0);recalcTotals()">
            <span style="color:var(--text-muted);font-size:0.85rem">%</span>
          </div>
          <div class="flex-row gap-sm" style="flex-wrap:wrap">
            <label class="form-check"><input type="checkbox" ${d.mostrar_cantidad?'checked':''} onchange="updateField('mostrar_cantidad',this.checked)"><label>Cantidad</label></label>
            <label class="form-check"><input type="checkbox" ${d.mostrar_notas?'checked':''} onchange="updateField('mostrar_notas',this.checked)"><label>Notas</label></label>
            <label class="form-check"><input type="checkbox" ${d.mostrar_totales?'checked':''} onchange="updateField('mostrar_totales',this.checked)"><label>Totales</label></label>
          </div>
        </div>
        <div class="totals-display" id="totals-display">
          <div class="total-item"><div class="label">BASE</div><div class="value">${formatMoney(totals.base)}</div></div>
          ${totals.dto > 0 ? `<div class="total-item"><div class="label">DTO ${d.descuento_pct}%</div><div class="value" style="color:var(--orange)">-${formatMoney(totals.dto)}</div></div>` : ''}
          ${d.aplicar_iva ? `<div class="total-item"><div class="label">IVA ${d.iva_porcentaje}%</div><div class="value">${formatMoney(totals.iva)}</div></div>` : ''}
          <div class="total-item"><div class="label">TOTAL</div><div class="value grand">${formatMoney(totals.total)}</div></div>
        </div>
      </div>

      <!-- Notes & Actions -->
      <hr class="separator">
      <div class="flex-row mb-md" style="align-items:flex-start;gap:16px;flex-wrap:wrap">
        <div class="form-group" style="flex:1;min-width:250px">
          <label class="form-label">Notas al pie</label>
          <textarea class="form-textarea" rows="3" placeholder="Notas adicionales..." onchange="updateField('notas',this.value)">${esc(d.notas)}</textarea>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-self:flex-end">
          <button class="btn btn-wa btn-sm" onclick="sendWhatsApp()">ğŸ“± WhatsApp</button>
          <button class="btn btn-orange btn-sm" onclick="convertToFactura()">ğŸ”„ â†’ Factura</button>
          <button class="btn btn-ghost btn-sm" onclick="previewPDF()">ğŸ‘ Vista Previa</button>
          <button class="btn btn-primary" onclick="generatePDF()">ğŸ–¨ï¸ Generar PDF</button>
        </div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getActiveTab() { return state.tabs.find(t => t.id === state.activeTab); }

function updateField(path, value) {
  const tab = getActiveTab(); if (!tab) return;
  const parts = path.split('.');
  let obj = tab.data;
  for (let i = 0; i < parts.length - 1; i++) obj = obj[parts[i]];
  obj[parts[parts.length - 1]] = value;
  tab.dirty = true;
  renderTabs();
}

function saveCurrentTabData() {
  // Fields are saved via onchange â€” this is a placeholder for future use
}

function updateConcepto(idx, field, value) {
  const tab = getActiveTab(); if (!tab) return;
  if (field === 'cantidad' || field === 'precio_base') value = parseFloat(value) || 0;
  tab.data.conceptos[idx][field] = value;
  tab.dirty = true;
  renderTabs(); recalcTotals();
}

function addRow() {
  const tab = getActiveTab(); if (!tab) return;
  tab.data.conceptos.push({ descripcion: '', cantidad: 1, precio_base: 0 });
  tab.dirty = true; renderTabs(); renderActiveTab();
}

function deleteRow(idx) {
  const tab = getActiveTab(); if (!tab) return;
  if (tab.data.conceptos.length <= 1) return;
  const removed = tab.data.conceptos.splice(idx, 1)[0];
  tab.undoStack.push(removed);
  if (tab.undoStack.length > 10) tab.undoStack.shift();
  tab.dirty = true; renderTabs(); renderActiveTab();
}

function undoDelete() {
  const tab = getActiveTab(); if (!tab || !tab.undoStack.length) return;
  tab.data.conceptos.push(tab.undoStack.pop());
  tab.dirty = true; renderTabs(); renderActiveTab();
}

function moveRow(idx, dir) {
  const tab = getActiveTab(); if (!tab) return;
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= tab.data.conceptos.length) return;
  const arr = tab.data.conceptos;
  [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]];
  tab.dirty = true; renderActiveTab();
}

function calcTotals(d) {
  let base = 0;
  (d.conceptos || []).forEach(c => { base += (parseFloat(c.cantidad) || 0) * (parseFloat(c.precio_base) || 0); });
  const dtoPct = parseInt(d.descuento_pct) || 0;
  const dto = base * dtoPct / 100;
  const baseNeta = base - dto;
  const ivaRate = d.aplicar_iva ? (parseInt(d.iva_porcentaje) || 21) / 100 : 0;
  const iva = baseNeta * ivaRate;
  return { base, dto, baseNeta, iva, total: baseNeta + iva };
}

function recalcTotals() {
  const tab = getActiveTab(); if (!tab) return;
  const totals = calcTotals(tab.data);
  const d = tab.data;
  const el = document.getElementById('totals-display');
  if (el) {
    el.innerHTML = `
      <div class="total-item"><div class="label">BASE</div><div class="value">${formatMoney(totals.base)}</div></div>
      ${totals.dto > 0 ? `<div class="total-item"><div class="label">DTO ${d.descuento_pct}%</div><div class="value" style="color:var(--orange)">-${formatMoney(totals.dto)}</div></div>` : ''}
      ${d.aplicar_iva ? `<div class="total-item"><div class="label">IVA ${d.iva_porcentaje}%</div><div class="value">${formatMoney(totals.iva)}</div></div>` : ''}
      <div class="total-item"><div class="label">TOTAL</div><div class="value grand">${formatMoney(totals.total)}</div></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLIENT AUTOCOMPLETE (#9)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onClientInput(input) {
  const q = input.value.toLowerCase().trim();
  const list = document.getElementById('client-autocomplete');
  if (q.length < 2) { list.classList.remove('show'); return; }
  const matches = Object.entries(state.clientes).filter(([name]) => name.toLowerCase().includes(q)).slice(0, 8);
  if (!matches.length) { list.classList.remove('show'); return; }
  list.innerHTML = matches.map(([name, c]) =>
    `<div class="autocomplete-item" onclick="selectClient('${esc(name)}')">
      <div>${esc(name)}</div>
      <div class="sub">${esc(c.dni || '')} ${esc(c.telefono || '')}</div>
    </div>`).join('');
  list.classList.add('show');
}

function selectClient(name) {
  const c = state.clientes[name]; if (!c) return;
  updateField('cliente.nombre', name);
  updateField('cliente.dni', c.dni || '');
  updateField('cliente.telefono', c.telefono || '');
  updateField('cliente.direccion', c.direccion || '');
  document.getElementById('client-autocomplete').classList.remove('show');
  renderActiveTab();
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.autocomplete-wrap')) {
    document.querySelectorAll('.autocomplete-list').forEach(l => l.classList.remove('show'));
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changePerfil(key) {
  const tab = getActiveTab(); if (!tab) return;
  const p = state.perfiles[key]; if (!p) return;
  tab.data.perfil_key = key;
  tab.data.empresa = { ...p };
  tab.dirty = true; renderActiveTab();
}

function savePerfilFromTab() {
  const tab = getActiveTab(); if (!tab) return;
  let key = tab.data.perfil_key || '';
  if (!key || key === '---') { key = prompt('Nombre para el nuevo perfil:'); if (!key) return; }
  state.perfiles[key] = { ...tab.data.empresa };
  tab.data.perfil_key = key;
  saveState(); toast('âœ“ Perfil guardado: ' + key, 'success');
}

function pickLogoFile() { document.getElementById('logo-file-input').click(); }
function handleLogoFile(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => { updateField('empresa.logo', e.target.result); renderActiveTab(); };
  reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearTab() {
  if (!confirm('Â¿Limpiar todos los datos de esta pestaÃ±a?')) return;
  const tab = getActiveTab(); if (!tab) return;
  const perfil = state.perfiles[tab.data.perfil_key] || {};
  tab.data.cliente = { nombre: '', dni: '', direccion: '', telefono: '' };
  tab.data.detalles = { numero: '', fecha: today() };
  tab.data.conceptos = [{ descripcion: '', cantidad: 1, precio_base: 0 }];
  tab.data.notas = ''; tab.data.descuento_pct = 0;
  tab.data.tecnico = { equipo: '', marca: '', averia: '', diagnostico: '' };
  tab.undoStack = []; tab.dirty = false;
  renderTabs(); renderActiveTab();
}

function convertToFactura() {
  const tab = getActiveTab(); if (!tab) return;
  const d = JSON.parse(JSON.stringify(tab.data));
  d.tipo_documento = 'FACTURA'; d.detalles.fecha = today(); d.detalles.numero = '';
  newTab(d);
  toast('âœ“ Convertido a Factura en nueva pestaÃ±a', 'success');
}

function sendWhatsApp() {
  const tab = getActiveTab(); if (!tab) return;
  const d = tab.data; const tel = (d.cliente.telefono || '').replace(/[^0-9]/g, '');
  if (!tel) { toast('âš  Introduce el telÃ©fono del cliente', 'error'); return; }
  const totals = calcTotals(d);
  const msg = `Hola ${d.cliente.nombre || 'cliente'}, le adjunto el documento ${d.tipo_documento} nÂº ${d.detalles.numero || 'borrador'} por un total de ${formatMoney(totals.total)}.\n\nRevise el archivo adjunto.\n\nAtentamente,\n${d.empresa.nombre}`;
  window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PDF GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPDFHtml(d) {
  const totals = calcTotals(d);
  const ivaRate = d.aplicar_iva ? (d.iva_porcentaje || 21) : 0;
  const color = d.empresa.color_tema || '#1a4f8b';
  const fecha = d.detalles.fecha ? new Date(d.detalles.fecha).toLocaleDateString('es-ES') : '';
  const isTecnico = d.tipo_documento === 'INFORME TÃ‰CNICO';

  const conceptosHtml = (d.conceptos || []).filter(c => c.descripcion).map(c => {
    const base = (c.cantidad || 0) * (c.precio_base || 0);
    return `<tr>
      <td>${esc(c.descripcion)}</td>
      ${d.mostrar_cantidad ? `<td style="text-align:center">${parseFloat(c.cantidad).toFixed(2)}</td>` : ''}
      <td style="text-align:right;white-space:nowrap">${parseFloat(c.precio_base).toFixed(2)} â‚¬</td>
      <td style="text-align:right;white-space:nowrap">${base.toFixed(2)} â‚¬</td>
      ${d.aplicar_iva ? `<td style="text-align:right;white-space:nowrap">${(base * ivaRate/100).toFixed(2)} â‚¬</td>` : ''}
      <td style="text-align:right;font-weight:600;white-space:nowrap">${(d.aplicar_iva ? base*(1+ivaRate/100) : base).toFixed(2)} â‚¬</td>
    </tr>`;
  }).join('');

  return `<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
  @page { size: A4; margin: 18mm 15mm 20mm 15mm; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 9.5pt; color: #1a1a1a; line-height: 1.5; background: #ffffff; padding: 0; margin: 0; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 3px solid ${color}; }
  .header .logo img { max-height: 70px; }
  .header .doc-type { text-align: right; }
  .header .doc-type h1 { font-size: 18pt; color: ${color}; font-weight: 700; margin: 0; }
  .header .doc-type .num { font-size: 10pt; color: #555; }
  .info-grid { display: flex; gap: 30px; margin-bottom: 20px; }
  .info-block { flex: 1; }
  .info-block h3 { font-size: 8.5pt; text-transform: uppercase; color: ${color}; letter-spacing: 1px; margin-bottom: 6px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
  .info-block p { font-size: 9pt; color: #333; margin: 2px 0; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  thead th { background: ${color}; color: white; padding: 8px 10px; font-size: 8.5pt; text-transform: uppercase; letter-spacing: 0.5px; text-align: left; }
  tbody td { padding: 8px 10px; border-bottom: 1px solid #e5e5e5; font-size: 9pt; }
  tbody tr:nth-child(even) { background: #f8f9fa; }
  .totals { margin-left: auto; width: 280px; }
  .totals .row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 9.5pt; }
  .totals .row.discount { color: #e67e22; }
  .totals .total-final { border-top: 2px solid ${color}; padding: 8px 0; margin-top: 4px; font-size: 13pt; font-weight: 700; color: ${color}; }
  .notes { background: #f8f9fa; border-left: 3px solid ${color}; padding: 10px 14px; margin-top: 20px; font-size: 8.5pt; color: #555; }
  .footer { text-align: center; font-size: 7.5pt; color: #999; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 8px; }
  .tecnico { background: #f0f4f8; border: 1px solid #dce3ea; border-radius: 6px; padding: 14px; margin-bottom: 18px; }
  .tecnico h3 { color: ${color}; font-size: 9pt; margin-bottom: 8px; }
  .tecnico .trow { display: flex; gap: 20px; margin-bottom: 4px; font-size: 9pt; }
  .tecnico .trow b { color: #555; min-width: 80px; }
</style></head><body>
  <div class="header">
    <div class="logo">${d.empresa.logo ? `<img src="${d.empresa.logo}" onerror="this.style.display='none'">` : ''}</div>
    <div class="doc-type">
      <h1>${esc(d.tipo_documento)}</h1>
      <div class="num">${d.detalles.numero ? `NÂº ${esc(d.detalles.numero)}` : ''}</div>
      <div class="num">${fecha}</div>
    </div>
  </div>
  <div class="info-grid">
    <div class="info-block">
      <h3>Emisor</h3>
      <p><strong>${esc(d.empresa.nombre)}</strong></p>
      <p>${esc(d.empresa.nif)}</p>
      <p style="white-space:pre-line">${esc(d.empresa.direccion)}</p>
      ${d.empresa.telefono ? `<p>Tel: ${esc(d.empresa.telefono)}</p>` : ''}
      ${d.empresa.email ? `<p>${esc(d.empresa.email)}</p>` : ''}
    </div>
    <div class="info-block">
      <h3>Receptor</h3>
      <p><strong>${esc(d.cliente.nombre)}</strong></p>
      ${d.cliente.dni ? `<p>${esc(d.cliente.dni)}</p>` : ''}
      <p style="white-space:pre-line">${esc(d.cliente.direccion)}</p>
      ${d.cliente.telefono ? `<p>Tel: ${esc(d.cliente.telefono)}</p>` : ''}
    </div>
  </div>
  ${isTecnico ? `<div class="tecnico"><h3>Datos TÃ©cnicos</h3>
    <div class="trow"><b>Equipo:</b> ${esc(d.tecnico.equipo)}</div>
    <div class="trow"><b>Marca:</b> ${esc(d.tecnico.marca)}</div>
    <div class="trow"><b>AverÃ­a:</b> ${esc(d.tecnico.averia)}</div>
    <div class="trow"><b>DiagnÃ³stico:</b> ${esc(d.tecnico.diagnostico)}</div>
  </div>` : ''}
  <table>
    <thead><tr>
      <th>DescripciÃ³n</th>
      ${d.mostrar_cantidad ? '<th style="text-align:center">Cant.</th>' : ''}
      <th style="text-align:right">P. Unit.</th>
      <th style="text-align:right">Base</th>
      ${d.aplicar_iva ? `<th style="text-align:right">IVA ${ivaRate}%</th>` : ''}
      <th style="text-align:right">Total</th>
    </tr></thead>
    <tbody>${conceptosHtml}</tbody>
  </table>
  ${d.mostrar_totales ? `<div class="totals">
    <div class="row"><span>Base Imponible:</span><span>${totals.base.toFixed(2)} â‚¬</span></div>
    ${totals.dto > 0 ? `<div class="row discount"><span>Descuento (${d.descuento_pct}%):</span><span>-${totals.dto.toFixed(2)} â‚¬</span></div>
    <div class="row"><span>Base Neta:</span><span>${totals.baseNeta.toFixed(2)} â‚¬</span></div>` : ''}
    ${d.aplicar_iva ? `<div class="row"><span>IVA (${ivaRate}%):</span><span>${totals.iva.toFixed(2)} â‚¬</span></div>` : ''}
    <div class="row total-final"><span>TOTAL</span><span>${totals.total.toFixed(2)} â‚¬</span></div>
  </div>` : ''}
  ${d.mostrar_notas && d.notas ? `<div class="notes"><strong>Notas:</strong> ${esc(d.notas)}</div>` : ''}
  ${d.empresa.iban ? `<div class="notes" style="margin-top:10px"><strong>Datos bancarios:</strong> ${esc(d.empresa.iban)}</div>` : ''}
  <div class="footer">Documento generado por ERB System â€” ${new Date().toLocaleDateString('es-ES')}</div>
</body></html>`;
}

function generatePDF() {
  const tab = getActiveTab(); if (!tab) return;
  const d = tab.data;
  setStatus('â³ Generando PDF...', 0);
  // Save client to DB
  if (d.cliente.nombre) {
    state.clientes[d.cliente.nombre] = { dni: d.cliente.dni, direccion: d.cliente.direccion, telefono: d.cliente.telefono };
  }
  const totals = calcTotals(d);
  // Save to history
  state.historial.push({
    id: Date.now(), tipo: d.tipo_documento, numero: d.detalles.numero,
    fecha: d.detalles.fecha, cliente: d.cliente.nombre, total: totals.total,
    data: JSON.parse(JSON.stringify(d)), creado: new Date().toISOString()
  });
  saveState();
  tab.dirty = false; renderTabs();
  _doPDFGeneration(d);
}

function _doPDFGeneration(d) {
  const html = buildPDFHtml(d);
  const nombre = `${(d.tipo_documento||'DOC').replace(/\s+/g,'_')}_${(d.cliente.nombre||'Sin_Cliente').replace(/[^a-zA-Z0-9]/g,'_').substring(0,25)}_${(d.detalles.numero||'SN').replace(/[^a-zA-Z0-9]/g,'_')}`;

  // Crear iframe oculto â€” el HTML completo (con <style> en <head>) se renderiza bien aquÃ­
  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'position:fixed;left:0;top:0;width:210mm;height:297mm;border:none;opacity:0;pointer-events:none;z-index:-1;';
  document.body.appendChild(iframe);

  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open(); doc.write(html); doc.close();

  // Esperar a que el contenido se renderice completamente
  setTimeout(() => {
    const opt = {
      margin: [10, 10, 10, 10], filename: nombre + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, letterRendering: true, scrollY: 0, windowWidth: doc.body.scrollWidth },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };
    html2pdf().set(opt).from(doc.body).save().then(() => {
      document.body.removeChild(iframe);
      setStatus('âœ“ PDF descargado correctamente');
      toast('âœ“ PDF generado y descargado', 'success');
    }).catch(err => {
      document.body.removeChild(iframe);
      setStatus('âœ— Error generando PDF');
      toast('âœ— Error: ' + err.message, 'error');
    });
  }, 600);
}

function previewPDF() {
  const tab = getActiveTab(); if (!tab) return;
  const html = buildPDFHtml(tab.data);
  const win = window.open('', '_blank');
  win.document.write(html); win.document.close();
  setStatus('ğŸ‘ Vista previa abierta');
}

function generateCombinedPDF() {
  if (state.tabs.length < 2) { toast('Necesitas al menos 2 pestaÃ±as para combinar', 'info'); return; }
  toast('â³ Generando PDF combinado...', 'info');

  // Construir HTML combinado con page breaks
  const pages = state.tabs.map(t => {
    const d = t.data;
    const totals = calcTotals(d);
    const color = d.empresa.color_tema || '#1a4f8b';
    const ivaRate = d.aplicar_iva ? (d.iva_porcentaje || 21) : 0;
    const fecha = d.detalles.fecha ? new Date(d.detalles.fecha).toLocaleDateString('es-ES') : '';
    const isTecnico = d.tipo_documento === 'INFORME TÃ‰CNICO';
    const conceptosHtml = (d.conceptos || []).filter(c => c.descripcion).map(c => {
      const base = (c.cantidad||0) * (c.precio_base||0);
      return `<tr><td>${esc(c.descripcion)}</td>${d.mostrar_cantidad ? `<td style="text-align:center">${parseFloat(c.cantidad).toFixed(2)}</td>` : ''}<td style="text-align:right">${parseFloat(c.precio_base).toFixed(2)} â‚¬</td><td style="text-align:right">${base.toFixed(2)} â‚¬</td>${d.aplicar_iva ? `<td style="text-align:right">${(base*ivaRate/100).toFixed(2)} â‚¬</td>` : ''}<td style="text-align:right;font-weight:600">${(d.aplicar_iva?base*(1+ivaRate/100):base).toFixed(2)} â‚¬</td></tr>`;
    }).join('');
    return `<div style="page-break-after:always;">
      <div class="header"><div class="logo">${d.empresa.logo?`<img src="${d.empresa.logo}" style="max-height:70px">`:''}</div><div class="doc-type"><h1>${esc(d.tipo_documento)}</h1><div class="num">${d.detalles.numero?`NÂº ${esc(d.detalles.numero)}`:''}</div><div class="num">${fecha}</div></div></div>
      <div class="info-grid"><div class="info-block"><h3>Emisor</h3><p><strong>${esc(d.empresa.nombre)}</strong></p><p>${esc(d.empresa.nif)}</p><p style="white-space:pre-line">${esc(d.empresa.direccion)}</p></div><div class="info-block"><h3>Receptor</h3><p><strong>${esc(d.cliente.nombre)}</strong></p>${d.cliente.dni?`<p>${esc(d.cliente.dni)}</p>`:''}<p style="white-space:pre-line">${esc(d.cliente.direccion)}</p></div></div>
      <table><thead><tr><th>DescripciÃ³n</th>${d.mostrar_cantidad?'<th style="text-align:center">Cant.</th>':''}<th style="text-align:right">P.Unit.</th><th style="text-align:right">Base</th>${d.aplicar_iva?`<th style="text-align:right">IVA ${ivaRate}%</th>`:''}<th style="text-align:right">Total</th></tr></thead><tbody>${conceptosHtml}</tbody></table>
      ${d.mostrar_totales?`<div class="totals"><div class="row"><span>Base:</span><span>${totals.base.toFixed(2)} â‚¬</span></div>${totals.dto>0?`<div class="row discount"><span>Dto (${d.descuento_pct}%):</span><span>-${totals.dto.toFixed(2)} â‚¬</span></div>`:''} ${d.aplicar_iva?`<div class="row"><span>IVA (${ivaRate}%):</span><span>${totals.iva.toFixed(2)} â‚¬</span></div>`:''}<div class="row total-final"><span>TOTAL</span><span>${totals.total.toFixed(2)} â‚¬</span></div></div>`:''}
    </div>`;
  }).join('');

  const firstColor = state.tabs[0]?.data?.empresa?.color_tema || '#1a4f8b';
  const combinedHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
    @page{size:A4;margin:18mm 15mm 20mm 15mm;}*{box-sizing:border-box;margin:0;padding:0;}body{font-family:'Helvetica Neue',Arial,sans-serif;font-size:9.5pt;color:#1a1a1a;line-height:1.5;}.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:14px;border-bottom:3px solid ${firstColor};}.header .doc-type{text-align:right;}.header .doc-type h1{font-size:18pt;color:${firstColor};font-weight:700;}.header .doc-type .num{font-size:10pt;color:#555;}.info-grid{display:flex;gap:30px;margin-bottom:20px;}.info-block{flex:1;}.info-block h3{font-size:8.5pt;text-transform:uppercase;color:${firstColor};letter-spacing:1px;margin-bottom:6px;border-bottom:1px solid #ddd;padding-bottom:3px;}.info-block p{font-size:9pt;color:#333;margin:2px 0;}table{width:100%;border-collapse:collapse;margin-bottom:20px;}thead th{background:${firstColor};color:white;padding:8px 10px;font-size:8.5pt;text-transform:uppercase;text-align:left;}tbody td{padding:8px 10px;border-bottom:1px solid #e5e5e5;font-size:9pt;}tbody tr:nth-child(even){background:#f8f9fa;}.totals{margin-left:auto;width:280px;}.totals .row{display:flex;justify-content:space-between;padding:5px 0;font-size:9.5pt;}.totals .row.discount{color:#e67e22;}.totals .total-final{border-top:2px solid ${firstColor};padding:8px 0;margin-top:4px;font-size:13pt;font-weight:700;color:${firstColor};}
  </style></head><body>${pages}</body></html>`;

  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'position:fixed;left:0;top:0;width:210mm;height:297mm;border:none;opacity:0;pointer-events:none;z-index:-1;';
  document.body.appendChild(iframe);
  const doc = iframe.contentDocument; doc.open(); doc.write(combinedHtml); doc.close();

  setTimeout(() => {
    html2pdf().set({
      margin: [10,10,10,10], filename: `PACK_ERB_${new Date().toISOString().slice(0,10)}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4' }
    }).from(doc.body).save().then(() => {
      document.body.removeChild(iframe);
      toast('âœ“ PDF combinado descargado', 'success');
    });
  }, 600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY MODAL (#5 #6 + PDF from JSON)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHistory() {
  document.getElementById('modal-title').textContent = 'ğŸ“‚ Historial de Documentos';
  const body = document.getElementById('modal-body');
  body.innerHTML = `
    <input class="form-input mb-md" id="hist-search" placeholder="ğŸ” Buscar por cliente, tipo o nÃºmero..." oninput="filterHistory()">
    <div id="hist-list" style="max-height:400px;overflow-y:auto;"></div>`;
  document.getElementById('modal-footer').innerHTML = `
    <button class="btn btn-ghost btn-sm" onclick="exportAllJSON()">ğŸ“¥ Exportar Todo</button>
    <button class="btn btn-ghost btn-sm" onclick="importJSON()">ğŸ“¤ Importar JSON</button>
    <input type="file" id="import-json-input" accept=".json" style="display:none" onchange="handleImportJSON(this)">
    <button class="btn btn-ghost" onclick="closeModal()">Cerrar</button>`;
  openModal(); filterHistory();
}

function filterHistory() {
  const q = (document.getElementById('hist-search')?.value || '').toLowerCase();
  const list = document.getElementById('hist-list');
  const filtered = state.historial.filter(h => {
    if (!q) return true;
    return (h.cliente||'').toLowerCase().includes(q) || (h.tipo||'').toLowerCase().includes(q) || (h.numero||'').toLowerCase().includes(q);
  }).sort((a, b) => new Date(b.creado) - new Date(a.creado));

  if (!filtered.length) { list.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:30px">Sin documentos</p>'; return; }
  list.innerHTML = filtered.map(h => `
    <div class="history-item" onclick="this.classList.toggle('selected')">
      <div class="info">
        <div class="title">${esc(h.tipo)} â€” ${esc(h.cliente||'Sin cliente')}</div>
        <div class="meta">NÂº ${esc(h.numero||'â€”')} | ${h.fecha ? new Date(h.fecha).toLocaleDateString('es-ES') : 'â€”'} | ${formatMoney(h.total)}</div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();viewPDFFromHistory(${h.id})" title="Ver PDF">ğŸ‘</button>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();regenPDFFromHistory(${h.id})" title="Regenerar PDF">ğŸ–¨ï¸</button>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openFromHistory(${h.id})" title="Abrir en editor">ğŸ“</button>
        <button class="btn btn-sm" style="color:var(--red)" onclick="event.stopPropagation();deleteFromHistory(${h.id})" title="Eliminar">ğŸ—‘</button>
      </div>
    </div>`).join('');
}

function openFromHistory(id) {
  const h = state.historial.find(x => x.id === id); if (!h) return;
  newTab(JSON.parse(JSON.stringify(h.data)));
  closeModal(); toast('âœ“ Documento abierto en editor', 'success');
}

function viewPDFFromHistory(id) {
  const h = state.historial.find(x => x.id === id); if (!h) return;
  const html = buildPDFHtml(h.data);
  const win = window.open('', '_blank');
  win.document.write(html); win.document.close();
  setStatus('ğŸ‘ Vista previa desde historial');
}

function regenPDFFromHistory(id) {
  const h = state.historial.find(x => x.id === id); if (!h) return;
  setStatus('â³ Generando PDF...', 0);
  _doPDFGeneration(h.data);
}

function deleteFromHistory(id) {
  if (!confirm('Â¿Eliminar este documento del historial?')) return;
  state.historial = state.historial.filter(x => x.id !== id);
  saveState(); filterHistory(); toast('âœ“ Eliminado', 'success');
}

function importJSON() { document.getElementById('import-json-input').click(); }
function handleImportJSON(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const d = JSON.parse(e.target.result);
      newTab(d); closeModal(); toast('âœ“ JSON importado', 'success');
    } catch(err) { toast('âœ— JSON invÃ¡lido: ' + err.message, 'error'); }
  };
  reader.readAsText(file);
}

function exportAllJSON() {
  const blob = new Blob([JSON.stringify(state.historial, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `ERB_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
  toast('âœ“ Backup exportado', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSettings() {
  document.getElementById('modal-title').textContent = 'âš™ï¸ ConfiguraciÃ³n';
  const perfilOpts = Object.keys(state.perfiles).map(k =>
    `<option value="${esc(k)}" ${k===state.config.perfil_default?'selected':''}>${esc(k)}</option>`).join('');
  const body = document.getElementById('modal-body');
  body.innerHTML = `
    <div class="form-group mb-md">
      <label class="form-label">Perfil por defecto</label>
      <select class="form-select" onchange="state.config.perfil_default=this.value;saveState()">${perfilOpts}</select>
    </div>
    <hr class="separator">
    <h3 style="font-size:0.9rem;color:var(--accent);margin:16px 0 8px">Perfiles de Empresa</h3>
    ${Object.entries(state.perfiles).map(([k, p]) => `
      <div class="history-item" style="margin-bottom:6px">
        <div class="info"><div class="title">${esc(k)}</div><div class="meta">${esc(p.nombre)} â€” ${esc(p.nif)}</div></div>
        <button class="btn btn-sm" style="color:var(--red)" onclick="if(confirm('Â¿Eliminar perfil ${esc(k)}?')){delete state.perfiles['${esc(k)}'];saveState();showSettings()}">ğŸ—‘</button>
      </div>`).join('')}
    <hr class="separator">
    <h3 style="font-size:0.9rem;color:var(--accent);margin:16px 0 8px">Base de Clientes (${Object.keys(state.clientes).length})</h3>
    <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:8px">Los clientes se guardan automÃ¡ticamente al generar PDFs.</p>
    ${Object.keys(state.clientes).length ? `<button class="btn btn-danger btn-sm" onclick="if(confirm('Â¿Borrar todos los clientes?')){state.clientes={};saveState();showSettings()}">Borrar todos los clientes</button>` : ''}
    <hr class="separator">
    <h3 style="font-size:0.9rem;color:var(--red);margin:16px 0 8px">Zona de peligro</h3>
    <button class="btn btn-danger btn-sm" onclick="if(confirm('Â¿BORRAR TODOS LOS DATOS? No se puede deshacer.')){localStorage.removeItem('${DB_KEY}');location.reload()}">ğŸ—‘ Resetear toda la app</button>
  `;
  document.getElementById('modal-footer').innerHTML = `<button class="btn btn-ghost" onclick="closeModal()">Cerrar</button>`;
  openModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal() { document.getElementById('modal-overlay').classList.add('active'); }
function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadState();
newTab();
</script>
</body>
</html>
